<Window x:Class="Nodify.StateMachine.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:Nodify.StateMachine"
        xmlns:nodify="http://miroiu.github.io/winfx/xaml/nodify"
        mc:Ignorable="d"
        Title="MainWindow"
        Height="450"
        Width="800">
    <Window.DataContext>
        <local:StateMachineViewModel />
    </Window.DataContext>

    <Window.Resources>
        <local:HalfSizeWithOffsetConverter x:Key="HalfSizeWithOffsetConverter" />
    </Window.Resources>

    <nodify:NodifyEditor ItemsSource="{Binding States}"
                         SelectedItems="{Binding SelectedStates}"
                         Connections="{Binding Transitions}"
                         PendingConnection="{Binding PendingTransition}"
                         DisconnectConnectorCommand="{Binding DisconnectStateCommand}"
                         ConnectionCompletedCommand="{Binding CreateTransitionCommand}">
        <nodify:NodifyEditor.InputBindings>
            <KeyBinding Key="Delete"
                        Command="{Binding DeleteSelectionCommand}" />
        </nodify:NodifyEditor.InputBindings>

        <nodify:NodifyEditor.Resources>
            <Style TargetType="{x:Type nodify:PendingConnection}"
                   BasedOn="{StaticResource {x:Type nodify:PendingConnection}}">
                <Setter Property="StrokeDashArray"
                        Value="" />
                <Setter Property="EnablePreview"
                        Value="True" />
                <Setter Property="BorderBrush"
                        Value="White" />
            </Style>
        </nodify:NodifyEditor.Resources>

        <nodify:NodifyEditor.PendingConnectionTemplate>
            <DataTemplate DataType="{x:Type local:TransitionViewModel}">
                <nodify:PendingConnection Source="{Binding Source, Mode=OneWayToSource}"
                                          Target="{Binding Target, Mode=OneWayToSource}">
                    <nodify:PendingConnection.Template>
                        <ControlTemplate TargetType="{x:Type nodify:PendingConnection}">
                            <nodify:DirectionalConnection Source="{TemplateBinding SourceAnchor}"
                                                          Target="{TemplateBinding TargetAnchor}"
                                                          Stroke="{TemplateBinding BorderBrush}"
                                                          StrokeThickness="{TemplateBinding StrokeThickness}"
                                                          StrokeDashArray="{TemplateBinding StrokeDashArray}"
                                                          Fill="{TemplateBinding BorderBrush}"
                                                          SourceOffset="{Binding Source.Size}"
                                                          OffsetMode="Edge" />
                        </ControlTemplate>
                    </nodify:PendingConnection.Template>
                </nodify:PendingConnection>
            </DataTemplate>
        </nodify:NodifyEditor.PendingConnectionTemplate>

        <nodify:NodifyEditor.ConnectionTemplate>
            <DataTemplate DataType="{x:Type local:TransitionViewModel}">
                <nodify:DirectionalConnection Source="{Binding Source.Anchor}"
                                              Target="{Binding Target.Anchor}"
                                              Stroke="White"
                                              Fill="White"
                                              SourceOffset="{Binding Source.Size}"
                                              TargetOffset="{Binding Target.Size}"
                                              OffsetMode="Edge" />
            </DataTemplate>
        </nodify:NodifyEditor.ConnectionTemplate>

        <nodify:NodifyEditor.ItemTemplate>
            <DataTemplate DataType="{x:Type local:StateViewModel}">
                <nodify:StateNode Content="{Binding}"
                                  IsConnected="{Binding Transitions.Count}"
                                  Size="{Binding Size, Mode=OneWayToSource, Converter={StaticResource HalfSizeWithOffsetConverter}, ConverterParameter=5}"
                                  Anchor="{Binding Anchor, Mode=OneWayToSource}">
                    <nodify:StateNode.ContentTemplate>
                        <DataTemplate DataType="{x:Type local:StateViewModel}">
                            <local:EditableTextBlock Text="{Binding Name}" />
                        </DataTemplate>
                    </nodify:StateNode.ContentTemplate>
                </nodify:StateNode>
            </DataTemplate>
        </nodify:NodifyEditor.ItemTemplate>

        <nodify:NodifyEditor.ItemContainerStyle>
            <Style TargetType="{x:Type nodify:ItemContainer}"
                   BasedOn="{StaticResource {x:Type nodify:ItemContainer}}">
                <Setter Property="BorderBrush"
                        Value="Transparent" />
                <Setter Property="Location"
                        Value="{Binding Location}" />
            </Style>
        </nodify:NodifyEditor.ItemContainerStyle>
    </nodify:NodifyEditor>
</Window>
